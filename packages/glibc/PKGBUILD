# Maintainer: protonesso <nagakamira@gmail.com>
# Contributor: protonesso <nagakamira@gmail.com>

pkgname=glibc
pkgver=2.28
pkgrel=9
pkgdesc="The GNU C Library"
arch=('x86_64' 'i586' 'aarch64' 'arm' 'mips' 'mipsel' 'powerpc64le' 'powerpc64' 'powerpc' 'sparc64' 'sparc' 's390x' 'microblaze' 'or1k' 'hppa' 'riscv64' 'riscv32')
url="http://www.gnu.org/software/libc"
license=('GPL' 'LGPL')
depends=('filesystem' 'tzdata' 'linux-headers')
backup=(etc/gai.conf
	etc/nscd.conf)
options=('docs' 'staticlibs')
install=$pkgname.install
source=(http://ftpmirror.gnu.org/gnu/$pkgname/$pkgname-$pkgver.tar.xz
	0001-Set-host.conf-multi-to-on-by-default.patch
	skip-error-msg-ld.so.conf.patch
	ldconfig-format-new.patch
	mkdir-ldconfig.patch
	nonscd.patch
	alternate_trim.patch
	madvise-bss.patch
	spinaphore.patch
	tzselect-proper-zone-file.patch
	large-page-huge-page.patch
	use_madv_free.patch
	malloc_tune.patch
	mathlto.patch
	vzeroupper-2.27.patch
	0001-x86-64-Remove-sysdeps-x86_64-fpu-s_sinf.S.patch
	pause.patch
	gcc-8-fix.patch
	spin-smarter.patch
	nostackshrink.patch
	strcpy-avx2.patch)
md5sums=('c81d2388896379997bc359d4f2084239'
         'e6a296c1df749a9b6748fbb919244c4a'
         'd92e953e3723a804f0fcb8a464f617dd'
         '5cd42d5b8136cae9fbc1f71957ccb848'
         'a2f3bf3888598a87f80766c4ef7ea368'
         '4dec27ee9a2efb2fe72b2b14cc224f28'
         'e7f3473a369116b0043f706c24fbf9f3'
         'f966477dc6e0ac52cf32662196f1a112'
         '5cda914ef4a35d1a21ce3bd71954820b'
         '0ae8a08e820447f41fbced1b18dacb6a'
         'cbb093c5b989d055cd15f9a5b4c8cb85'
         'd641d1105b61a9c0eb8c93e9a9411578'
         '21b190f92ead0b537b0c499f3b4b58e4'
         'fe5c44c2f49d51ba043505a895c6f694'
         '96deb62b272f428406210e272d46a810'
         '41e1e2dc829dae7ed82aa83ecb1b4693'
         'd8b7596a2f43126c28549f576ecfb1da'
         '3d02d61e0325eaf96afc3716b96ff4ef'
         '2819faa1fb184fc622f045d07235e3c8'
         '15ce96f7415600e6ae9053e72cd205f0'
         '83973dc3e41d8fd34aebcdc08f6ca667')

prepare() {
	cd $pkgname-$pkgver
	patch -p1 -i $srcdir/0001-Set-host.conf-multi-to-on-by-default.patch
	patch -p1 -i $srcdir/skip-error-msg-ld.so.conf.patch
	patch -p1 -i $srcdir/ldconfig-format-new.patch
	patch -p1 -i $srcdir/mkdir-ldconfig.patch
	patch -p1 -i $srcdir/nonscd.patch
	patch -p1 -i $srcdir/alternate_trim.patch
	patch -p1 -i $srcdir/madvise-bss.patch
	patch -p1 -i $srcdir/spinaphore.patch
	patch -p1 -i $srcdir/tzselect-proper-zone-file.patch
	patch -p1 -i $srcdir/large-page-huge-page.patch
	patch -p1 -i $srcdir/use_madv_free.patch
	patch -p1 -i $srcdir/malloc_tune.patch
	patch -p1 -i $srcdir/mathlto.patch
	patch -p1 -i $srcdir/vzeroupper-2.27.patch
	patch -R -p1 -i $srcdir/0001-x86-64-Remove-sysdeps-x86_64-fpu-s_sinf.S.patch
	patch -p1 -i $srcdir/pause.patch
	patch -p1 -i $srcdir/gcc-8-fix.patch
	patch -p1 -i $srcdir/spin-smarter.patch
	patch -p1 -i $srcdir/nostackshrink.patch
	patch -p1 -i $srcdir/strcpy-avx2.patch

	mkdir build
	cd build

	echo "slibdir=/usr/lib" >> configparms
	echo "rtlddir=/usr/lib" >> configparms
	echo "sbindir=/usr/bin" >> configparms
	echo "rootsbindir=/usr/bin" >> configparms
}

build() {
	export CFLAGS="${CFLAGS/-fno-plt}"
	export CXXFLAGS="${CXXFLAGS/-fno-plt}"
	export CFLAGS="${CFLAGS/-D_FORTIFY_SOURCE=2}"
	export CXXFLAGS="${CXXFLAGS/-D_FORTIFY_SOURCE=2}"
	export CFLAGS="${CFLAGS/-Os}"
	export CXXFLAGS="${CXXFLAGS/-Os}"
	export CFLAGS="$CFLAGS -g2"
	export CXXFLAGS="$CXXFLAGS -g2"

	cd $pkgname-$pkgver
	cd build

	../configure \
		--prefix=/usr \
		--libdir=/usr/lib \
		--libexecdir=/usr/lib \
		--with-pkgversion="Minitena $pkgver" \
		--with-bugurl='https://github.com/minitena/source/issues' \
		--without-gd \
		--without-selinux \
		--enable-add-ons \
		--enable-bind-now \
		--enable-kernel=3.12.0 \
		--enable-lock-elision \
		--enable-stack-protector=strong \
		--enable-stackguard-randomization \
		--disable-profile \
		--disable-werror \
		--build=$CHOST $GLIBCOPTS
	make
}

package() {
	cd $pkgname-$pkgver
	cd build

	install -dm755 $pkgdir/etc
	touch $pkgdir/etc/ld.so.conf

	make install_root=$pkgdir install

	rm -rf $pkgdir/etc/ld.so.{cache,conf}

	rm -rf $pkgdir/usr/bin/{tzselect,zdump,zic}

	install -dm755 $pkgdir/usr/lib/{locale,systemd/system,tmpfiles.d}
	install -m644 ../nscd/nscd.conf $pkgdir/etc/nscd.conf
	install -m644 ../nscd/nscd.service $pkgdir/usr/lib/systemd/system
	install -m644 ../nscd/nscd.tmpfiles $pkgdir/usr/lib/tmpfiles.d/nscd.conf
	install -dm755 $pkgdir/var/db/nscd

	install -m644 ../posix/gai.conf $pkgdir/etc/gai.conf

	make SUPPORTED-LOCALES="en_US.UTF-8/UTF-8" install_root=$pkgdir localedata/install-locales

	cd $pkgdir
	rm -rf {,usr/}{,local/}{,share/}{doc,man,info,locale} {,usr/}{,local/}{,share/},opt/*}/{man,info} {,usr/}{,local/}{,share/}{doc,gtk-doc} opt/*/{doc,gtk-doc}
}
