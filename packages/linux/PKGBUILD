# Maintainer: protonesso <nagakamira@gmail.com>
# Contributor: protonesso <nagakamira@gmail.com>

pkgname=('linux' 'linux-devel')
pkgbase=linux
pkgver=4.19.1
zerover=$pkgver
pkgrel=26
arch=('x86_64' 'i586' 'aarch64' 'arm')
url="https://www.kernel.org/"
license=('GPL')
options=('!strip')
makedepends=('kmod' 'bc' 'libelf' 'xz-utils' 'lz4' 'libressl')
source=("https://cdn.kernel.org/pub/linux/kernel/v4.x/$pkgbase-$pkgver.tar.xz"
	'x86_64-config'
	'i586-config'
	'arm64-config'
	'arm-config'
	'riscv32-config'
	'riscv64-config'
	'60-linux.hook'
	'90-linux.hook')
md5sums=('6de5f0c6c0eb5d27386579894fcf31ab'
         'f5caea6773cb4ecd74673683bfb3d22a'
         'a85fb27ffa8da2a09be34fc98000327b'
         '8c624cf101e5c6a3def2f798674cb4fe'
         '070e4c1a8cae7d277379e82bb971a21f'
         '3c7ee7c9689008b373b9600771a0f281'
         'edc507e53d2d00069aebdac98d35def1'
         '8e58bafc66f67c38f306d0f854f92a8b'
         '183cfae4e585c53261679ac9b72070ad')

prepare() {
	cd $pkgbase-$pkgver
	msg "Preparing kernel..."
	make mrproper

	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			cp $srcdir/x86_64-config .config
			;;
		i586)
			export XKARCH="i386"
			cp $srcdir/i586-config .config
			;;
		aarch64)
			export XKARCH="arm64"
			cp $srcdir/arm64-config .config
			;;
		arm)
			export XKARCH="arm"
			cp $srcdir/arm-config .config
			;;
		riscv32)
			export XKARCH="riscv"
			cp $srcdir/riscv32-config config
			;;
		riscv64)
			export XKARCH="riscv"
			cp $srcdir/riscv64-config config
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	case $CARCH in
		riscv32|riscv64)
			make ARCH=$XKARCH allnoconfig KCONFIG_ALLCONFIG=config
			;;
		*)
			make ARCH=$XKARCH olddefconfig
	esac
}

build() {
	msg "Building kernel..."

	cd $pkgbase-$pkgver
	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			;;
		i586)
			export XKARCH="i386"
			;;
		aarch64)
			export XKARCH="arm64"
			;;
		arm)
			export XKARCH="arm"
			;;
		riscv32|riscv64)
			export XKARCH="riscv"
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	make ARCH=$XKARCH
}

package_linux() {
	pkgdesc="The Linux kernel"

	msg "Installing kernel contents to the $pkgdir directory..."

	cd $pkgbase-$pkgver
	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			export IMG="arch/x86/boot/bzImage"
			;;
		i586)
			export XKARCH="i386"
			export IMG="arch/x86/boot/bzImage"
			;;
		aarch64)
			export XKARCH="arm64"
			export IMG="arch/arm64/boot/Image"
			;;
		arm)
			export XKARCH="arm"
			export IMG="arch/arm/boot/zImage"
			;;
		riscv32|riscv64)
			export XKARCH="riscv"
			export IMG="vmlinux"
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	mkdir -p $pkgdir/usr/lib/modules/

	sed -i '2iexit 0' scripts/depmod.sh
	make ARCH=$XKARCH INSTALL_MOD_PATH=$pkgdir/usr modules_install

	mkdir -p $pkgdir/boot
	cp -i $IMG $pkgdir/boot/vmlinuz-linux
	cp -i System.map $pkgdir/boot/System.map-linux
	cp -i .config $pkgdir/boot/config-linux

	case $CARCH in
		aarch64|arm)
			make ARCH=$XKARCH INSTALL_DTBS_PATH=$PKG/boot/dtbs dtbs_install
			;;
	esac

	install -dm755 $pkgdir/usr/share/libalpm/hooks/
	install -m644 $srcdir/*linux.hook $pkgdir/usr/share/libalpm/hooks/

	local subst="
		s|%KVER%|$zerover|g
	"

	sed -i "$subst" $pkgdir/usr/share/libalpm/hooks/60-linux.hook
	sed -i "$subst" $pkgdir/usr/share/libalpm/hooks/90-linux.hook

	cd $pkgdir/usr/lib/modules/$zerover
	rm -f source build
	ln -sf ../../../src/linux build
}

package_linux-devel() {
	pkgdesc="Development files of Linux kernel to build various modules"

	case $CARCH in
		x86_64)
			export KARCH="x86"
			export SUBKARCH="x86_64"
			;;
		i586)
			export KARCH="x86"
			export SUBKARCH="i386"
			;;
		aarch64)
			export KARCH="arm64"
			;;
		arm)
			export KARCH="arm"
			;;
		riscv32|riscv64)
			export XKARCH="riscv"
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	cd $pkgbase-$pkgver
	install -Dm644 Makefile $pkgdir/usr/src/linux/Makefile
	install -Dm644 kernel/Makefile $pkgdir/usr/src/linux/kernel/Makefile
	install -Dm644 .config $pkgdir/usr/src/linux/.config
	mkdir -p $pkgdir/usr/src/linux/include

	for i in acpi asm-generic config crypto drm generated linux math-emu \
		media net pcmcia scsi sound trace uapi video xen; do
		if [ -d include/$i ]; then
			cp -a include/$i $pkgdir/usr/src/linux/include
		fi
	done

	mkdir -p $pkgdir/usr/src/linux/arch/$KARCH
	cp -a arch/$KARCH/include $pkgdir/usr/src/linux/arch/$KARCH

	cp Module.symvers $pkgdir/usr/src/linux
	cp -a scripts $pkgdir/usr/src/linux

	mkdir -p $pkgdir/usr/src/linux/arch/$KARCH/kernel
	cp arch/$KARCH/Makefile $pkgdir/usr/src/linux/arch/$KARCH
	if [ "$SUBKARCH" = "i386" ]; then
		mkdir -p $pkgdir/usr/src/linux/arch/x86
		cp arch/x86/Makefile_32.cpu $pkgdir/usr/src/linux/arch/x86
	fi
	if [ "$KARCH" = "x86" ]; then
		mkdir -p $pkgdir/usr/src/linux/arch/x86/kernel
		cp arch/x86/kernel/asm-offsets.s $pkgdir/usr/src/linux/arch/x86/kernel
	fi

	for i in bt8xx cx88 saa7134; do
		mkdir -p $pkgdir/usr/src/linux/drivers/media/pci/${i}
		cp -a drivers/media/pci/${i}/*.h $pkgdir/usr/src/linux/drivers/media/pci/${i}
	done
	for i in cpia2 em28xx pwc; do
		mkdir -p $pkgdir/usr/src/linux/drivers/media/usb/${i}
		cp -a drivers/media/usb/${i}/*.h $pkgdir/usr/src/linux/drivers/media/usb/${i}
	done
	mkdir -p $pkgdir/usr/src/linux/drivers/media/i2c
	cp drivers/media/i2c/*.h $pkgdir/usr/src/linux/drivers/media/i2c
	for i in cx25840; do
		mkdir -p $pkgdir/usr/src/linux/drivers/media/i2c/${i}
		cp -a drivers/media/i2c/${i}/*.h $pkgdir/usr/src/linux/drivers/media/i2c/${i}
	done

	mkdir -p $pkgdir/usr/src/linux/drivers/md
	cp drivers/md/*.h $pkgdir/usr/src/linux/drivers/md

	mkdir -p $pkgdir/usr/src/linux/include/linux
	cp include/linux/inotify.h $pkgdir/usr/src/linux/include/linux

	mkdir -p $pkgdir/usr/src/linux/net/mac80211/
	cp net/mac80211/*.h $pkgdir/usr/src/linux/net/mac80211

	mkdir -p $pkgdir/usr/src/linux/include/config/dvb/
	cp include/config/dvb/*.h $pkgdir/usr/src/linux/include/config/dvb/

	mkdir -p $pkgdir/usr/src/linux/drivers/media/dvb-frontends
	cp drivers/media/dvb-frontends/lgdt330x.h \
		$pkgdir/usr/src/linux/drivers/media/dvb-frontends/
	cp drivers/media/i2c/msp3400-driver.h $pkgdir/usr/src/linux/drivers/media/i2c/

	mkdir -p $pkgdir/usr/src/linux/drivers/media/usb/dvb-usb
	cp drivers/media/usb/dvb-usb/*.h $pkgdir/usr/src/linux/drivers/media/usb/dvb-usb/
	mkdir -p $pkgdir/usr/src/linux/drivers/media/dvb-frontends
	cp drivers/media/dvb-frontends/*.h $pkgdir/usr/src/linux/drivers/media/dvb-frontends/
	mkdir -p $pkgdir/usr/src/linux/drivers/media/tuners
	cp drivers/media/tuners/*.h $pkgdir/usr/src/linux/drivers/media/tuners/

	mkdir -p $pkgdir/usr/src/linux/fs/xfs/libxfs
	mkdir -p $pkgdir/usr/src/linux/mm
	cp fs/xfs/libxfs/xfs_sb.h $pkgdir/usr/src/linux/fs/xfs/libxfs/xfs_sb.h

	case "$CHOST" in
		x86_64*)
			mkdir -p $pkgdir/usr/src/linux/tools/objtool
			cp tools/objtool/objtool $pkgdir/usr/src/linux/tools/objtool
			;;
	esac

	for i in $(find . -name "Kconfig*"); do
		mkdir -p $pkgdir/usr/src/linux/$(echo $i | sed 's|/Kconfig.*||')
		cp $i $pkgdir/usr/src/linux/$i
	done

	case "$KARCH" in
		i386|x86_64) _args="arm* riscv*";;
		arm|arm64) _args="x86* riscv*";;
		riscv32|riscv64) _args="x86* arm*";;
	esac

	for rmarch in alpha avr32 blackfin cris frv h8300 \
		ia64 m* p* s* um v850 xtensa ${_args}; do
		rm -rf $pkgdir/usr/src/linux/arch/$rmarch
	done
}
