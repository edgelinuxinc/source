# Maintainer: protonesso <nagakamira@gmail.com>
# Contributor: protonesso <nagakamira@gmail.com>

pkgname=linux
pkgver=4.18.10
pkgrel=9
pkgdesc="The Linux kernel"
arch=('x86_64')
url="https://www.kernel.org/"
license=('GPL')
options=('!strip')
makedepends=('kmod' 'bc' 'libelf' 'xz-utils' 'libressl')
source=("https://cdn.kernel.org/pub/linux/kernel/v4.x/$pkgname-$pkgver.tar.xz"
	'x86_64-config'
	'aarch64-config')
md5sums=('c2d42d10d9288a088832d69d36950c8e'
         '948ee9c6624dabe41b0cf66553a8ed20'
         'b4af02dc4610134bad5331a495da1b0e')

prepare() {
	msg "Preparing kernel..."

	cd $pkgname-$pkgver
	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			;;
		aarch64)
			export XKARCH="arm64"
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	make mrproper

	cp -a $srcdir/$XKARCH-config .config
}

build() {
	msg "Building kernel..."

	cd $pkgname-$pkgver
	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			;;
		aarch64)
			export XKARCH="arm64"
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	make ARCH=$XKARCH
}

package() {
	set +e
	msg "Installing kernel contents to the $pkgdir directory..."

	cd $pkgname-$pkgver
	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			export IMG="arch/x86/boot/bzImage"
			;;
		aarch64)
			export XKARCH="arm64"
			export IMG="arch/arm64/boot/Image"
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	mkdir -p $pkgdir/usr/lib/modules/
	make ARCH=$XKARCH INSTALL_MOD_PATH=$pkgdir/usr modules_install

	rm -rf $pkgdir/usr/lib/modules/{source,build}

	mkdir -p $pkgdir/boot
	cp $IMG $pkgdir/boot/vmlinuz-$pkgver

	ln -sf vmlinuz-$pkgver $pkgdir/boot/vmlinuz

	case $CARCH in
		aarch64)
			make ARCH=$XKARCH INSTALL_DTBS_PATH=$PKG/boot/dtbs dtbs_install
			;;
	esac
	set -e
}
