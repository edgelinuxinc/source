# Maintainer: protonesso <nagakamira@gmail.com>
# Contributor: protonesso <nagakamira@gmail.com>

pkgname=linux
pkgver=4.18.16
reiserfs4patchver=4.18.0
pkgrel=22
pkgdesc="The Linux kernel"
arch=('x86_64' 'i586' 'aarch64' 'arm')
url="https://www.kernel.org/"
license=('GPL')
options=('!strip')
makedepends=('kmod' 'bc' 'libelf' 'xz-utils' 'libressl')
source=("https://cdn.kernel.org/pub/linux/kernel/v4.x/$pkgname-$pkgver.tar.xz"
	"http://downloads.sourceforge.net/project/reiser4/reiser4-for-linux-4.x/reiser4-for-$reiserfs4patchver.patch.gz"
	'x86_64-config'
	'i586-config'
	'arm64-config'
	'60-linux.hook'
	'90-linux.hook')
md5sums=('df6309b196f94fdf1df598d160f6ebce'
         '4aa8cdbac33df4bee88fadefa9cdb8c4'
         '0ed3f99b195845dd331cb900f782c296'
         '7b7f232bda232dbdba16a4ff75768a80'
         'fee4eee6814d4aa8d156390e04720f76'
         '8e58bafc66f67c38f306d0f854f92a8b'
         'f99d0be58396fd6564c894f4511c37b2')

prepare() {
	cd $pkgname-$pkgver
	gzip -dc $srcdir/reiser4-for-$reiserfs4patchver.patch.gz | patch -p1

	msg "Preparing kernel..."
	make mrproper

	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			cp $srcdir/x86_64-config .config
			;;
		i586)
			export XKARCH="i386"
			cp $srcdir/i586-config .config
			;;
		aarch64)
			export XKARCH="arm64"
			cp $srcdir/arm64-config .config
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	make ARCH=$XKARCH olddefconfig
}

build() {
	msg "Building kernel..."

	cd $pkgname-$pkgver
	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			;;
		i586)
			export XKARCH="i386"
			;;
		aarch64)
			export XKARCH="arm64"
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	make ARCH=$XKARCH
}

package() {
	msg "Installing kernel contents to the $pkgdir directory..."

	cd $pkgname-$pkgver
	case $CARCH in
		x86_64)
			export XKARCH="x86_64"
			export IMG="arch/x86/boot/bzImage"
			;;
		i586)
			export XKARCH="i386"
			export IMG="arch/x86/boot/bzImage"
			;;
		aarch64)
			export XKARCH="arm64"
			export IMG="arch/arm64/boot/Image"
			;;
		*)
			echo "Architecture is not set or is not supported"
			exit 1
	esac

	mkdir -p $pkgdir/usr/lib/modules/
	make ARCH=$XKARCH INSTALL_MOD_PATH=$pkgdir/usr modules_install

	mkdir -p $pkgdir/boot
	cp $IMG $pkgdir/boot/vmlinuz-linux

	case $CARCH in
		aarch64)
			make ARCH=$XKARCH INSTALL_DTBS_PATH=$PKG/boot/dtbs dtbs_install
			;;
	esac

	install -dm755 $pkgdir/usr/share/libalpm/hooks/
	install -m644 $srcdir/*linux.hook $pkgdir/usr/share/libalpm/hooks/

	local subst="
		s|%KVER%|$pkgver|g
	"

	sed -i "$subst" $pkgdir/usr/share/libalpm/hooks/60-linux.hook
	sed -i "$subst" $pkgdir/usr/share/libalpm/hooks/90-linux.hook
}
